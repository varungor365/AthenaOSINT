<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AthenaOSINT | Situation Room</title>
    <!-- Tailwind CSS (Using CDN for simplicity as per existing patterns) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Inter', sans-serif;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .agent-card {
            transition: all 0.3s ease;
        }

        .agent-card.active {
            border-color: #58a6ff;
            box-shadow: 0 0 10px rgba(88, 166, 255, 0.2);
        }

        .terminal-window {
            background-color: #010409;
            border: 1px solid #30363d;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0d1117;
        }

        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #58a6ff;
        }

        .typing-indicator::after {
            content: '...';
            animation: typing 1s infinite;
        }

        @keyframes typing {
            0% {
                content: '';
            }

            25% {
                content: '.';
            }

            50% {
                content: '..';
            }

            75% {
                content: '...';
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-gray-900 p-4 flex justify-between items-center shadow-lg z-10">
        <div class="flex items-center space-x-3">
            <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
            <h1 class="text-xl font-bold tracking-wider text-white">SITUATION ROOM <span
                    class="text-xs text-gray-500 ml-2 font-normal border border-gray-700 px-2 py-0.5 rounded">RESTRICTED</span>
            </h1>
        </div>
        <div class="flex items-center space-x-4">
            <span id="connection-status" class="text-xs text-green-500 mono">‚óè CONNECTED</span>
            <a href="/" class="text-gray-400 hover:text-white transition text-sm">EXIT TO DASHBOARD</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Sidebar: Active Agents -->
        <aside class="w-64 bg-gray-900 border-r border-gray-800 p-4 flex flex-col space-y-4">
            <h2 class="text-xs uppercase text-gray-500 font-bold tracking-widest mb-2">Active Agents</h2>

            <div id="agent-admin" class="agent-card bg-gray-800 p-3 rounded border border-gray-700 opacity-90">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-bold text-white text-sm">COMMANDER</span>
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                </div>
                <p class="text-xs text-gray-400">Mission Oversight</p>
            </div>

            <div id="agent-lead" class="agent-card bg-gray-800 p-3 rounded border border-gray-700 opacity-50">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-bold text-blue-400 text-sm">LEAD_INVESTIGATOR</span>
                    <div
                        class="spinner w-2 h-2 rounded-full border-2 border-blue-500 border-t-transparent animate-spin hidden">
                    </div>
                </div>
                <p class="text-xs text-gray-400">Strategy & Planning</p>
            </div>

            <div id="agent-tool" class="agent-card bg-gray-800 p-3 rounded border border-gray-700 opacity-50">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-bold text-purple-400 text-sm">TOOL_SPECIALIST</span>
                    <div
                        class="spinner w-2 h-2 rounded-full border-2 border-purple-500 border-t-transparent animate-spin hidden">
                    </div>
                </div>
                <p class="text-xs text-gray-400">OSINT Execution</p>
            </div>

            <div class="mt-auto border-t border-gray-800 pt-4">
                <h3 class="text-xs text-gray-500 mb-2">Live Intel Feed</h3>
                <div id="intel-feed" class="text-xs font-mono text-green-400 h-32 overflow-y-auto space-y-1">
                    <!-- Intel items -->
                </div>
            </div>
        </aside>

        <!-- Main Terminal Area -->
        <main class="flex-1 flex flex-col p-6 relative">

            <!-- Terminal Output -->
            <div id="terminal"
                class="terminal-window flex-1 rounded-lg p-4 mb-4 overflow-y-auto font-mono text-sm leading-relaxed space-y-2 relative">
                <div class="text-gray-500">Initializing Secure Channel...</div>
                <div class="text-gray-500"> uplink established.</div>
                <div class="text-blue-400 mt-2">Welcome, Commander. The team is ready.</div>
                <div class="text-gray-400 mb-4">Enter your objective below to begin the operation.</div>

                <!-- Messages will be injected here -->
            </div>

            <!-- Input Area -->
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <span class="text-green-500 font-bold">></span>
                </div>
                <input type="text" id="mission-input"
                    class="block w-full pl-8 pr-4 py-3 bg-gray-900 border border-gray-700 text-white rounded focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 mono"
                    placeholder="Enter mission objective (e.g., 'Investigate user @darkweb_king')" autocomplete="off">
                <button id="send-btn" class="absolute inset-y-0 right-0 px-4 text-gray-400 hover:text-white font-bold">
                    SEND
                </button>
            </div>

        </main>
    </div>

    <!-- Scripts -->
    <script>
        const socket = io();
        const terminal = document.getElementById('terminal');
        const input = document.getElementById('mission-input');
        const sendBtn = document.getElementById('send-btn');
        const intelFeed = document.getElementById('intel-feed');

        // Agents UI
        const agents = {
            'Commander_Admin': document.getElementById('agent-admin'),
            'Lead_Investigator': document.getElementById('agent-lead'),
            'Tool_Specialist': document.getElementById('agent-tool')
        };
        const activeClass = ['opacity-100', 'border-blue-500'];
        const inactiveClass = ['opacity-50', 'border-gray-700'];

        function highlightAgent(name) {
            // Reset all
            Object.values(agents).forEach(el => {
                if (el) {
                    el.classList.remove('opacity-100', 'border-blue-500');
                    el.classList.add('opacity-50', 'border-gray-700');
                    el.querySelector('.spinner')?.classList.add('hidden');
                }
            });

            // Highlight active
            const el = agents[name];
            if (el) {
                el.classList.remove('opacity-50', 'border-gray-700');
                el.classList.add('opacity-100', 'border-blue-500');
                el.querySelector('.spinner')?.classList.remove('hidden');
            }
        }

        function appendLog(text, sender = 'System') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });

            let color = 'text-gray-300';
            if (sender === 'Lead_Investigator') color = 'text-blue-400';
            if (sender === 'Tool_Specialist') color = 'text-purple-400';
            if (sender === 'Commander_Admin') color = 'text-green-400';
            if (sender === 'System') color = 'text-gray-500 italic';

            div.className = `mb-1 ${color}`;
            div.innerHTML = `<span class="opacity-50 mr-2">[${timestamp}]</span> <span class="font-bold mr-1">${sender}:</span> ${text.replace(/\n/g, '<br>')}`;

            terminal.appendChild(div);
            terminal.scrollTop = terminal.scrollHeight;

            if (agents[sender]) highlightAgent(sender);
        }

        // Send Mission
        function sendMission() {
            const mission = input.value.trim();
            if (!mission) return;

            appendLog(mission, 'Commander_Admin');
            input.value = '';
            input.disabled = true;

            socket.emit('start_research', { objective: mission });
            appendLog("Mission transmission... waiting for team ack.", "System");
        }

        sendBtn.addEventListener('click', sendMission);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMission();
        });

        // Socket Events
        socket.on('research_update', (data) => {
            // data = { sender: '...', content: '...' }
            appendLog(data.content, data.sender);

            // If tool output found, add to intel feed
            if (data.sender === 'Tool_Specialist' && data.content.includes('Found')) {
                const item = document.createElement('div');
                item.textContent = "> " + data.content.substring(0, 40) + "...";
                intelFeed.prepend(item);
            }
        });

        socket.on('research_complete', (data) => {
            appendLog("Mission Complete.", "System");
            input.disabled = false;
            highlightAgent('Commander_Admin'); // Return control
            input.focus();
        });

        socket.on('error', (data) => {
            appendLog(`ERROR: ${data.msg}`, "System");
            input.disabled = false;
        });

    </script>
</body>

</html>